name: ai-license-scan

on:
  pull_request:              # PR ãŒé–‹ã‹ã‚ŒãŸï¼æ›´æ–°ã•ã‚ŒãŸã¨ãã ã‘å®Ÿè¡Œ

permissions:
  contents: read
  pull-requests: write
  checks: write
  actions: read

jobs:
  scanoss-code-scan:
    runs-on: ubuntu-latest

    steps:
      # â‘  ã‚½ãƒ¼ã‚¹å–å¾—
      - uses: actions/checkout@v4

      # â‘¡ SCANOSS Code Scan - æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨
      - name: Run SCANOSS Code Scan
        id: scanoss
        uses: scanoss/gha-code-scan@v1          # â† æ­£ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        # ä»£æ›¿æ¡ˆ: ç›´æ¥Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨
        # run: |
        #   pip install scanoss
        #   scanoss-py scan . --format=sarif --output=scanoss.sarif
        with:
          policies: copyleft                    # Copyleft(GPL/LGPL/AGPL) ã‚’ NG ã«
          policies.halt_on_failure: true        # é•åãŒã‚ã‚Œã°ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã«
          output.filepath: scanoss.sarif        # SARIF å‡ºåŠ›
          # dependencies.enabled: false         # ä¾å­˜è§£æã¯ä¸è¦ãªã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ

      # â‘¢ SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ã¨ä¿®æ­£ - 2025å¹´7æœˆå¯¾å¿œ
      - name: Validate and fix SARIF file
        run: |
          if [ -f scanoss.sarif ]; then
            echo "ğŸ” SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ä¸­..."
            
            # åŸºæœ¬çš„ãªJSONæ¤œè¨¼
            if ! jq empty scanoss.sarif 2>/dev/null; then
              echo "âŒ ç„¡åŠ¹ãªJSONãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"
              exit 1
            fi
            
            # GitHub SARIF 2.1.0 ä»•æ§˜ã«æº–æ‹ ã™ã‚‹ã‚ˆã†ä¿®æ­£
            jq '{
              "$schema": "https://json.schemastore.org/sarif-2.1.0.json",
              "version": "2.1.0",
              "runs": [
                {
                  "tool": {
                    "driver": {
                      "name": "SCANOSS",
                      "version": "1.0.0",
                      "informationUri": "https://www.scanoss.com/",
                      "rules": []
                    }
                  },
                  "results": (
                    if .runs and (.runs | length > 0) and .runs[0].results then
                      .runs[0].results
                    else
                      []
                    end
                  )
                }
              ]
            }' scanoss.sarif > scanoss_fixed.sarif
            
            mv scanoss_fixed.sarif scanoss.sarif
            echo "âœ… SARIF ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ GitHub 2.1.0 ä»•æ§˜ã«ä¿®æ­£ã—ã¾ã—ãŸ"
            
            # çµæœã®ç¢ºèª
            echo "ğŸ“Š ã‚¹ã‚­ãƒ£ãƒ³çµæœ:"
            jq '.runs[0].results | length' scanoss.sarif || echo "çµæœãªã—"
            
          else
            echo "âŒ SARIFãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 1
          fi

      # â‘£ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã•ã‚ŒãŸãƒ­ã‚°å‡ºåŠ›
      - name: Show scan command + result path
        run: |
          echo "::notice title=Scan Command::${{ steps.scanoss.outputs.stdout-scan-command || 'scanoss scan executed' }}"
          echo "::notice title=Result File::${{ steps.scanoss.outputs.result-filepath || 'scanoss.sarif' }}"
          
      # â‘¤ ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ä¿å­˜ - ç›£æŸ»è¨¼è·¡ã®ãŸã‚
      - name: Upload SARIF results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: scanoss-sarif-results
          path: scanoss.sarif
          retention-days: 30

      # â‘¥ GitHub Advanced Securityçµ±åˆï¼ˆã‚¨ãƒ©ãƒ¼è¨±å®¹ï¼‰
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: scanoss.sarif
          category: license-scan
        continue-on-error: true  # SARIFã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ç¶šè¡Œ

      # â‘¦ ä»£æ›¿æ‰‹æ®µï¼šç›´æ¥Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
      - name: Fallback - Direct SCANOSS Python scan
        if: failure()
        run: |
          echo "ğŸ”„ SCANOSSã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã—ãŸãŸã‚ã€ç›´æ¥Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ä½¿ç”¨ã—ã¾ã™"
          pip install scanoss
          scanoss-py scan . --format=sarif --output=scanoss_fallback.sarif
          
          # Copyleftãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®ãƒã‚§ãƒƒã‚¯
          if jq -r '.runs[0].results[]?.message?.text // empty' scanoss_fallback.sarif | grep -i -E "(GPL|LGPL|AGPL)"; then
            echo "âŒ Copyleftãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            exit 1
          fi
          
          echo "âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¾ã—ãŸ"
